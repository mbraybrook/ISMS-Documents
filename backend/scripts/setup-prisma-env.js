#!/usr/bin/env node
/**
 * Postinstall script to set up Prisma environment
 * This ensures that npx prisma commands work correctly by:
 * 1. Creating a .env.local file with the correct absolute DATABASE_URL
 * 2. Creating a wrapper script in node_modules/.bin/prisma that sets DATABASE_URL
 */

const fs = require('fs');
const path = require('path');

const backendDir = __dirname.replace(/[\\/]scripts$/, '');
const projectRoot = path.resolve(backendDir, '..');
const dbPath = path.join(backendDir, 'prisma', 'dev.db');
const absoluteDbPath = path.resolve(dbPath);
const dbUrl = `file:${absoluteDbPath}`;

// Create .env.local with absolute path
const envLocalPath = path.join(backendDir, '.env.local');
const envLocalContent = `# Auto-generated by postinstall script
# This file ensures npx prisma commands work correctly from any directory
# DO NOT commit this file to version control
DATABASE_URL="${dbUrl}"
`;

// Create wrapper script for Prisma CLI in backend/node_modules/.bin
// We target backend/node_modules because that's where npx looks when running from backend/
const rootBinDir = path.join(backendDir, 'node_modules', '.bin');
const prismaWrapperPath = path.join(rootBinDir, 'prisma');
const prismaOriginalPath = path.join(rootBinDir, 'prisma-original');

// Ensure .bin directory exists
if (!fs.existsSync(rootBinDir)) {
  fs.mkdirSync(rootBinDir, { recursive: true });
}

// Backup original prisma if it exists and we haven't already
if (fs.existsSync(prismaWrapperPath) && !fs.existsSync(prismaOriginalPath)) {
  // Check if it's already our wrapper (has "Wrapper for Prisma CLI" comment)
  const existingContent = fs.readFileSync(prismaWrapperPath, 'utf8');
  if (!existingContent.includes('Wrapper for Prisma CLI')) {
    fs.copyFileSync(prismaWrapperPath, prismaOriginalPath);
  }
}

// Find the actual Prisma CLI binary
let prismaCliPath = path.join(projectRoot, 'node_modules', 'prisma', 'build', 'index.js');
if (!fs.existsSync(prismaCliPath)) {
  // Try backend node_modules
  prismaCliPath = path.join(backendDir, 'node_modules', 'prisma', 'build', 'index.js');
}

const wrapperScript = `#!/bin/bash
# Wrapper for Prisma CLI that ensures correct DATABASE_URL resolution
# This allows npx prisma to work from any directory
# Auto-generated by backend/scripts/setup-prisma-env.js

# Get the backend directory
BACKEND_DIR="${backendDir}"
DB_PATH="${absoluteDbPath}"

# Export the resolved DATABASE_URL
export DATABASE_URL="file:${absoluteDbPath}"

# Change to backend directory to ensure schema.prisma is found
cd "$BACKEND_DIR" || exit 1

# Run the actual Prisma CLI
exec node "${prismaCliPath}" "$@"
`;

try {
  // Write .env.local
  fs.writeFileSync(envLocalPath, envLocalContent);

  // Write wrapper script
  // IMPORTANT: Unlink existing file/symlink first to avoid following symlinks and overwriting target
  if (fs.existsSync(prismaWrapperPath)) {
    fs.unlinkSync(prismaWrapperPath);
  }
  fs.writeFileSync(prismaWrapperPath, wrapperScript);
  fs.chmodSync(prismaWrapperPath, '755');

  // Write backend/prisma/.env to fix npx prisma path resolution
  // This file is prioritized by Prisma CLI when running from backend/ or backend/prisma/
  // and ./dev.db resolves correctly relative to backend/prisma/
  const prismaEnvPath = path.join(backendDir, 'prisma', '.env');
  const prismaEnvContent = `# Auto-generated by setup-prisma-env.js
# This file ensures npx prisma commands find the database at the correct location
# relative to schema.prisma
DATABASE_URL="file:./dev.db"
`;
  fs.writeFileSync(prismaEnvPath, prismaEnvContent);

  console.log('[PRISMA] Created .env.local with absolute DATABASE_URL');
  console.log('[PRISMA] Created prisma/.env with relative DATABASE_URL');
  console.log(`[PRISMA] Database path: ${absoluteDbPath}`);
  console.log('[PRISMA] Created Prisma wrapper in node_modules/.bin/prisma');
} catch (error) {
  console.error('[PRISMA] Failed to set up Prisma environment:', error.message);
  process.exit(1);
}

