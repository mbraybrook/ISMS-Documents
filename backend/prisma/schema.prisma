generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Acknowledgment {
  id              String   @id
  userId          String
  documentId      String
  documentVersion String
  acknowledgedAt  DateTime @default(now())
  Document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentId, documentVersion])
  @@index([documentId])
  @@index([userId])
}

model Asset {
  id               String         @id
  date             DateTime
  assetCategoryId  String
  assetSubCategory String?
  owner            String
  primaryUser      String?
  location         String?
  manufacturer     String?
  model            String?
  nameSerialNo     String?
  cdeImpacting     Boolean        @default(false)
  classificationId String
  purpose          String?
  notes            String?
  cost             String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  Classification   Classification @relation(fields: [classificationId], references: [id])
  AssetCategory    AssetCategory  @relation(fields: [assetCategoryId], references: [id])
  Risk             Risk[]

  @@index([date])
  @@index([owner])
  @@index([classificationId])
  @@index([assetCategoryId])
}

model AssetCategory {
  id          String   @id
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Asset       Asset[]
  Risk        Risk[]

  @@index([name])
}

model Classification {
  id          String   @id
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Asset       Asset[]

  @@index([name])
}

model Control {
  id                               String            @id
  code                             String            @unique
  title                            String
  description                      String?
  selectedForRiskAssessment        Boolean           @default(false)
  selectedForContractualObligation Boolean           @default(false)
  selectedForLegalRequirement      Boolean           @default(false)
  selectedForBusinessRequirement   Boolean           @default(false)
  justification                    String?
  controlText                      String?
  purpose                          String?
  guidance                         String?
  otherInformation                 String?
  category                         String?
  isStandardControl                Boolean           @default(false)
  createdAt                        DateTime          @default(now())
  updatedAt                        DateTime
  documentControls                 DocumentControl[]
  riskControls                     RiskControl[]

  @@index([selectedForBusinessRequirement])
  @@index([selectedForLegalRequirement])
  @@index([selectedForContractualObligation])
  @@index([selectedForRiskAssessment])
  @@index([isStandardControl])
  @@index([category])
  @@index([code])
}

model Document {
  id                      String            @id
  title                   String
  type                    String
  storageLocation         String
  sharePointSiteId        String?
  sharePointDriveId       String?
  sharePointItemId        String?
  confluenceSpaceKey      String?
  confluencePageId        String?
  version                 String
  status                  String
  ownerUserId             String
  lastReviewDate          DateTime?
  nextReviewDate          DateTime?
  requiresAcknowledgement Boolean           @default(false)
  lastChangedDate         DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  documentUrl             String?
  Acknowledgment          Acknowledgment[]
  owner                   User              @relation("DocumentOwner", fields: [ownerUserId], references: [id])
  DocumentControl         DocumentControl[]
  DocumentRisk            DocumentRisk[]
  ReviewTask              ReviewTask[]

  @@index([nextReviewDate])
  @@index([ownerUserId])
  @@index([status])
  @@index([type])
}

model DocumentControl {
  documentId String
  controlId  String
  control    Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([documentId, controlId])
  @@index([controlId])
  @@index([documentId])
}

model DocumentRisk {
  documentId String
  riskId     String
  risk       Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([documentId, riskId])
  @@index([riskId])
  @@index([documentId])
}

model InterestedParty {
  id                      String   @id
  name                    String   @unique
  group                   String?
  description             String?
  dateAdded               DateTime?
  requirements            String?
  addressedThroughISMS    Boolean?
  howAddressedThroughISMS String?
  sourceLink              String?
  keyProductsServices     String?
  ourObligations          String?
  theirObligations        String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime
  risks                   Risk[]

  @@index([group])
  @@index([name])
}

model Legislation {
  id                    String          @id
  dateAdded             DateTime?
  interestedParty       String?
  actRegulationRequirement String
  description           String?
  riskOfNonCompliance   String?
  howComplianceAchieved String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime
  risks                 LegislationRisk[]

  @@index([actRegulationRequirement])
  @@index([interestedParty])
}

model ReviewTask {
  id             String    @id
  documentId     String
  reviewerUserId String
  dueDate        DateTime
  completedDate  DateTime?
  changeNotes    String?
  status         String    @default("PENDING")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  reviewer       User      @relation(fields: [reviewerUserId], references: [id])
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([dueDate])
  @@index([reviewerUserId])
  @@index([documentId])
}

model Risk {
  id                            String          @id
  externalId                    String?
  title                         String
  description                   String?
  dateAdded                     DateTime        @default(now())
  riskCategory                  String?
  riskNature                    String?
  ownerUserId                   String?
  assetCategory                 String?
  assetId                       String?
  assetCategoryId               String?
  interestedPartyId             String
  threatDescription             String?
  archived                      Boolean         @default(false)
  expiryDate                    DateTime?
  lastReviewDate                DateTime?
  nextReviewDate                DateTime?
  confidentialityScore          Int             @default(1)
  integrityScore                Int             @default(1)
  availabilityScore             Int             @default(1)
  riskScore                     Int?
  likelihood                    Int             @default(1)
  calculatedScore               Int
  initialRiskTreatmentCategory  String?
  mitigatedConfidentialityScore Int?
  mitigatedIntegrityScore       Int?
  mitigatedAvailabilityScore    Int?
  mitigatedRiskScore            Int?
  mitigatedLikelihood           Int?
  mitigatedScore                Int?
  mitigationImplemented         Boolean         @default(false)
  mitigationDescription         String?
  residualRiskTreatmentCategory String?
  annexAControlsRaw             String?
  createdAt                     DateTime        @default(now())
  updatedAt                     DateTime
  DocumentRisk                  DocumentRisk[]
  interestedParty               InterestedParty @relation(fields: [interestedPartyId], references: [id])
  linkedAssetCategory           AssetCategory?  @relation(fields: [assetCategoryId], references: [id])
  asset                         Asset?          @relation(fields: [assetId], references: [id])
  owner                         User?           @relation("RiskOwner", fields: [ownerUserId], references: [id])
  riskControls                  RiskControl[]
  legislationRisks              LegislationRisk[]

  @@index([interestedPartyId])
  @@index([assetCategoryId])
  @@index([assetId])
  @@index([mitigationImplemented])
  @@index([residualRiskTreatmentCategory])
  @@index([initialRiskTreatmentCategory])
  @@index([ownerUserId])
  @@index([nextReviewDate])
  @@index([expiryDate])
  @@index([archived])
  @@index([riskNature])
  @@index([riskCategory])
  @@index([externalId])
  @@index([calculatedScore])
}

model RiskControl {
  riskId    String
  controlId String
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)
  risk      Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([riskId, controlId])
  @@index([controlId])
  @@index([riskId])
}

model LegislationRisk {
  legislationId String
  riskId        String
  legislation   Legislation @relation(fields: [legislationId], references: [id], onDelete: Cascade)
  risk          Risk        @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([legislationId, riskId])
  @@index([riskId])
  @@index([legislationId])
}

model SoAExport {
  id                String   @id
  generatedByUserId String
  generatedAt       DateTime @default(now())
  exportFormat      String
  filePath          String?
  User              User     @relation(fields: [generatedByUserId], references: [id])

  @@index([generatedAt])
  @@index([generatedByUserId])
}

model User {
  id             String           @id
  displayName    String
  email          String           @unique
  entraObjectId  String           @unique
  role           String           @default("STAFF")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Acknowledgment Acknowledgment[]
  Document       Document[]     @relation("DocumentOwner")
  ReviewTask     ReviewTask[]
  ownedRisks     Risk[]         @relation("RiskOwner")
  SoAExport      SoAExport[]

  @@index([entraObjectId])
  @@index([email])
}
