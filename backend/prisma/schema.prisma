// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String types with constraints
// UserRole values: ADMIN, EDITOR, STAFF
model User {
  id            String   @id @default(uuid())
  displayName   String
  email         String   @unique
  entraObjectId String   @unique
  role          String   @default("STAFF") // ADMIN, EDITOR, STAFF
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ownedDocuments    Document[]     @relation("DocumentOwner")
  ownedRisks        Risk[]         @relation("RiskOwner")
  reviewTasks       ReviewTask[]
  acknowledgments   Acknowledgment[]
  generatedSoAExports SoAExport[]

  @@index([email])
  @@index([entraObjectId])
}

// DocumentType values: POLICY, PROCEDURE, MANUAL, RECORD, TEMPLATE, OTHER
// StorageLocation values: SHAREPOINT, CONFLUENCE
// DocumentStatus values: DRAFT, IN_REVIEW, APPROVED, SUPERSEDED
model Document {
  id                   String           @id @default(uuid())
  title                String
  type                 String           // POLICY, PROCEDURE, MANUAL, RECORD, TEMPLATE, OTHER
  storageLocation      String           // SHAREPOINT, CONFLUENCE
  sharePointSiteId     String?
  sharePointDriveId    String?
  sharePointItemId     String?
  confluenceSpaceKey   String?
  confluencePageId     String?
  version              String
  status               String           // DRAFT, IN_REVIEW, APPROVED, SUPERSEDED
  ownerUserId          String
  lastReviewDate       DateTime?
  nextReviewDate       DateTime?
  requiresAcknowledgement Boolean       @default(false)
  lastChangedDate      DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  // Relations
  owner                User             @relation("DocumentOwner", fields: [ownerUserId], references: [id])
  reviewTasks          ReviewTask[]
  acknowledgments      Acknowledgment[]
  documentControls     DocumentControl[]
  documentRisks        DocumentRisk[]

  @@index([type])
  @@index([status])
  @@index([ownerUserId])
  @@index([nextReviewDate])
}

// ReviewTaskStatus values: PENDING, COMPLETED, OVERDUE
model ReviewTask {
  id            String           @id @default(uuid())
  documentId    String
  reviewerUserId String
  dueDate       DateTime
  completedDate DateTime?
  changeNotes   String?
  status        String           @default("PENDING") // PENDING, COMPLETED, OVERDUE
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  document      Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  reviewer      User             @relation(fields: [reviewerUserId], references: [id])

  @@index([documentId])
  @@index([reviewerUserId])
  @@index([dueDate])
  @@index([status])
}

model Acknowledgment {
  id              String   @id @default(uuid())
  userId          String
  documentId      String
  documentVersion String
  acknowledgedAt  DateTime @default(now())

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([userId, documentId, documentVersion])
  @@index([userId])
  @@index([documentId])
}


// ControlCategory values: ORGANIZATIONAL, PEOPLE, PHYSICAL, TECHNOLOGICAL
// Control selection reasons: RISK_ASSESSMENT (auto), CONTRACTUAL_OBLIGATION, LEGAL_REQUIREMENT, BUSINESS_REQUIREMENT
model Control {
  id                  String              @id @default(uuid())
  code                String              @unique
  title               String
  description         String?
  // Selection reasons for Statement of Applicability
  // RISK_ASSESSMENT is automatically set based on risk-control relationships
  selectedForRiskAssessment        Boolean @default(false) // Auto-computed from risk relationships
  selectedForContractualObligation  Boolean @default(false) // User-selectable
  selectedForLegalRequirement       Boolean @default(false) // User-selectable
  selectedForBusinessRequirement   Boolean @default(false) // User-selectable
  justification       String?             // Justification for selection/non-selection
  // ISO 27002 control text fields
  controlText         String?             // The "Control" section text
  purpose             String?             // The "Purpose" section text
  guidance            String?             // The "Guidance" section text
  otherInformation    String?            // The "Other information" section text
  category            String?            // ORGANIZATIONAL, PEOPLE, PHYSICAL, TECHNOLOGICAL
  isStandardControl   Boolean            @default(false) // Flag for ISO 27002 controls
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  riskControls        RiskControl[]
  documentControls    DocumentControl[]

  @@index([code])
  @@index([category])
  @@index([isStandardControl])
  @@index([selectedForRiskAssessment])
  @@index([selectedForContractualObligation])
  @@index([selectedForLegalRequirement])
  @@index([selectedForBusinessRequirement])
}

// ApplicabilitySource values: AUTO_FROM_RISK, MANUAL_OVERRIDE
model RiskControl {
  riskId    String
  controlId String

  // Relations
  risk      Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([riskId, controlId])
  @@index([riskId])
  @@index([controlId])
}

model DocumentControl {
  documentId String
  controlId  String

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  control    Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([documentId, controlId])
  @@index([documentId])
  @@index([controlId])
}

model DocumentRisk {
  documentId String
  riskId     String

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  risk       Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([documentId, riskId])
  @@index([documentId])
  @@index([riskId])
}

// SoAExportFormat values: EXCEL, PDF
model SoAExport {
  id            String          @id @default(uuid())
  generatedByUserId String
  generatedAt  DateTime        @default(now())
  exportFormat String          // EXCEL, PDF
  filePath     String?

  // Relations
  generatedBy  User            @relation(fields: [generatedByUserId], references: [id])

  @@index([generatedByUserId])
  @@index([generatedAt])
}

model Classification {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assets      Asset[]

  @@index([name])
}

model AssetCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assets      Asset[]
  risks       Risk[]

  @@index([name])
}

model Asset {
  id                String   @id @default(uuid())
  date              DateTime
  assetCategoryId   String
  assetSubCategory  String?
  owner             String
  primaryUser       String?
  location          String?
  manufacturer      String?
  model             String?
  nameSerialNo      String?
  cdeImpacting      Boolean  @default(false)
  classificationId  String
  purpose           String?
  notes             String?
  cost              String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  category          AssetCategory @relation(fields: [assetCategoryId], references: [id])
  classification   Classification @relation(fields: [classificationId], references: [id])
  risks             Risk[]

  @@index([assetCategoryId])
  @@index([classificationId])
  @@index([owner])
  @@index([date])
}

// RiskCategory values: INFORMATION_SECURITY, OPERATIONAL, FINANCIAL, COMPLIANCE, REPUTATIONAL, STRATEGIC, OTHER
// RiskNature values: STATIC, INSTANCE
// RiskTreatmentCategory values: RETAIN, MODIFY, SHARE, AVOID
model Risk {
  id                  String   @id @default(uuid())
  externalId          String?
  title               String
  description         String?
  
  // Grey Section: Basic Risk Information
  dateAdded           DateTime @default(now())
  riskCategory        String?  // INFORMATION_SECURITY, OPERATIONAL, FINANCIAL, COMPLIANCE, REPUTATIONAL, STRATEGIC, OTHER
  riskNature          String?  // STATIC, INSTANCE
  ownerUserId         String?
  assetCategory       String?  // Deprecated - kept for backward compatibility
  assetId             String?
  assetCategoryId     String?
  interestedParty     String?
  threatDescription   String?
  
  // Risk Lifecycle Management
  archived            Boolean  @default(false)
  expiryDate          DateTime? // For INSTANCE risks - optional expiry date
  lastReviewDate      DateTime? // For STATIC risks - last review date
  nextReviewDate      DateTime? // For STATIC risks - next review date
  
  // Orange Section: Existing Controls - Initial Assessment
  confidentialityScore Int      @default(1)
  integrityScore      Int      @default(1)
  availabilityScore   Int      @default(1)
  riskScore           Int?     // The "R" score (overall risk score)
  likelihood          Int      @default(1)
  calculatedScore     Int
  initialRiskTreatmentCategory String? // RETAIN, MODIFY, SHARE, AVOID
  
  // Green Section: Additional Controls - Mitigated Assessment
  mitigatedConfidentialityScore Int?
  mitigatedIntegrityScore      Int?
  mitigatedAvailabilityScore  Int?
  mitigatedRiskScore          Int?
  mitigatedLikelihood         Int?
  mitigatedScore              Int?
  mitigationImplemented      Boolean @default(false)
  mitigationDescription       String?
  residualRiskTreatmentCategory String? // RETAIN, MODIFY, SHARE, AVOID
  
  annexAControlsRaw   String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  owner               User?    @relation("RiskOwner", fields: [ownerUserId], references: [id])
  asset               Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)
  linkedAssetCategory AssetCategory? @relation(fields: [assetCategoryId], references: [id], onDelete: SetNull)
  riskControls        RiskControl[]
  documentRisks       DocumentRisk[]

  @@index([calculatedScore])
  @@index([externalId])
  @@index([riskCategory])
  @@index([riskNature])
  @@index([archived])
  @@index([expiryDate])
  @@index([nextReviewDate])
  @@index([ownerUserId])
  @@index([initialRiskTreatmentCategory])
  @@index([residualRiskTreatmentCategory])
  @@index([mitigationImplemented])
  @@index([assetId])
  @@index([assetCategoryId])
}

