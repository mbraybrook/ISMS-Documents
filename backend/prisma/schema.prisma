generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:postgres@localhost:5432/isms_db?schema=public"
}

model Acknowledgment {
  id              String   @id
  userId          String
  documentId      String
  documentVersion String
  acknowledgedAt  DateTime @default(now())
  Document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentId, documentVersion])
  @@index([documentId])
  @@index([userId])
}

model Asset {
  id               String         @id
  date             DateTime
  assetCategoryId  String
  assetSubCategory String?
  owner            String
  primaryUser      String?
  location         String?
  manufacturer     String?
  model            String?
  nameSerialNo     String?
  cdeImpacting     Boolean        @default(false)
  classificationId String
  purpose          String?
  notes            String?
  cost             String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  Classification   Classification @relation(fields: [classificationId], references: [id])
  AssetCategory    AssetCategory  @relation(fields: [assetCategoryId], references: [id])
  Risk             Risk[]

  @@index([date])
  @@index([owner])
  @@index([classificationId])
  @@index([assetCategoryId])
}

model AssetCategory {
  id          String   @id
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Asset       Asset[]
  Risk        Risk[]

  @@index([name])
}

model Classification {
  id          String   @id
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Asset       Asset[]

  @@index([name])
}

model Control {
  id                               String            @id
  code                             String            @unique
  title                            String
  description                      String?
  selectedForRiskAssessment        Boolean           @default(false)
  selectedForContractualObligation Boolean           @default(false)
  selectedForLegalRequirement      Boolean           @default(false)
  selectedForBusinessRequirement   Boolean           @default(false)
  justification                    String?
  controlText                      String?
  purpose                          String?
  guidance                         String?
  otherInformation                 String?
  category                         String?
  isStandardControl                Boolean           @default(false)
  implemented                      Boolean           @default(false)
  createdAt                        DateTime          @default(now())
  updatedAt                        DateTime
  documentControls                 DocumentControl[]
  riskControls                     RiskControl[]
  supplierControls                 SupplierControlLink[]

  @@index([selectedForBusinessRequirement])
  @@index([selectedForLegalRequirement])
  @@index([selectedForContractualObligation])
  @@index([selectedForRiskAssessment])
  @@index([isStandardControl])
  @@index([category])
  @@index([code])
  @@index([implemented])
}

model Document {
  id                      String            @id
  title                   String
  type                    String
  storageLocation         String
  sharePointSiteId        String?
  sharePointDriveId       String?
  sharePointItemId        String?
  confluenceSpaceKey      String?
  confluencePageId        String?
  version                 String
  status                  String
  ownerUserId             String
  lastReviewDate          DateTime?
  nextReviewDate          DateTime?
  requiresAcknowledgement Boolean           @default(false)
  lastChangedDate         DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  documentUrl             String?
  Acknowledgment          Acknowledgment[]
  owner                   User              @relation("DocumentOwner", fields: [ownerUserId], references: [id])
  DocumentControl         DocumentControl[]
  DocumentRisk            DocumentRisk[]
  ReviewTask              ReviewTask[]
  TrustDocSetting         TrustDocSetting?

  @@index([nextReviewDate])
  @@index([ownerUserId])
  @@index([status])
  @@index([type])
}

model DocumentControl {
  documentId String
  controlId  String
  control    Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([documentId, controlId])
  @@index([controlId])
  @@index([documentId])
}

model DocumentRisk {
  documentId String
  riskId     String
  risk       Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([documentId, riskId])
  @@index([riskId])
  @@index([documentId])
}

model InterestedParty {
  id                      String    @id
  name                    String    @unique
  group                   String?
  description             String?
  dateAdded               DateTime?
  requirements            String?
  addressedThroughISMS    Boolean?
  howAddressedThroughISMS String?
  sourceLink              String?
  keyProductsServices     String?
  ourObligations          String?
  theirObligations        String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime
  risks                   Risk[]

  @@index([group])
  @@index([name])
}

model Legislation {
  id                       String            @id
  dateAdded                DateTime?
  interestedParty          String?
  actRegulationRequirement String
  description              String?
  riskOfNonCompliance      String?
  howComplianceAchieved    String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime
  risks                    LegislationRisk[]

  @@index([actRegulationRequirement])
  @@index([interestedParty])
}

model ReviewTask {
  id             String    @id
  documentId     String?
  supplierId     String?
  reviewerUserId String
  dueDate        DateTime
  completedDate  DateTime?
  changeNotes    String?
  status         String    @default("PENDING")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  reviewer       User      @relation(fields: [reviewerUserId], references: [id])
  document       Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  supplier       Supplier? @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([dueDate])
  @@index([reviewerUserId])
  @@index([documentId])
  @@index([supplierId])
}

model Risk {
  id                            String            @id
  title                         String
  description                   String?
  dateAdded                     DateTime          @default(now())
  riskCategory                  String?
  riskNature                    String?
  ownerUserId                   String?
  department                    String?
  status                        String            @default("DRAFT")
  wizardData                    String?
  rejectionReason               String?
  mergedIntoRiskId              String?
  assetCategory                 String?
  assetId                       String?
  assetCategoryId               String?
  interestedPartyId             String
  threatDescription             String?
  archived                      Boolean           @default(false)
  expiryDate                    DateTime?
  lastReviewDate                DateTime?
  nextReviewDate                DateTime?
  confidentialityScore          Int               @default(1)
  integrityScore                Int               @default(1)
  availabilityScore             Int               @default(1)
  riskScore                     Int?
  likelihood                    Int               @default(1)
  calculatedScore               Int
  initialRiskTreatmentCategory  String?
  mitigatedConfidentialityScore Int?
  mitigatedIntegrityScore       Int?
  mitigatedAvailabilityScore    Int?
  mitigatedRiskScore            Int?
  mitigatedLikelihood           Int?
  mitigatedScore                Int?
  mitigationImplemented         Boolean           @default(false)
  mitigationDescription         String?
  residualRiskTreatmentCategory String?
  annexAControlsRaw             String?
  embedding                     Json?
  createdAt                     DateTime          @default(now())
  updatedAt                     DateTime
  DocumentRisk                  DocumentRisk[]
  interestedParty               InterestedParty   @relation(fields: [interestedPartyId], references: [id])
  linkedAssetCategory           AssetCategory?    @relation(fields: [assetCategoryId], references: [id])
  asset                         Asset?            @relation(fields: [assetId], references: [id])
  owner                         User?             @relation("RiskOwner", fields: [ownerUserId], references: [id])
  riskControls                  RiskControl[]
  legislationRisks              LegislationRisk[]
  isSupplierRisk                Boolean  @default(false)
  supplierRisks                  SupplierRiskLink[]

  @@index([interestedPartyId])
  @@index([assetCategoryId])
  @@index([assetId])
  @@index([mitigationImplemented])
  @@index([residualRiskTreatmentCategory])
  @@index([initialRiskTreatmentCategory])
  @@index([ownerUserId])
  @@index([nextReviewDate])
  @@index([expiryDate])
  @@index([archived])
  @@index([riskNature])
  @@index([riskCategory])
  @@index([calculatedScore])
  @@index([department])
  @@index([status])
}

model RiskControl {
  riskId    String
  controlId String
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)
  risk      Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([riskId, controlId])
  @@index([controlId])
  @@index([riskId])
}

model LegislationRisk {
  legislationId String
  riskId        String
  legislation   Legislation @relation(fields: [legislationId], references: [id], onDelete: Cascade)
  risk          Risk        @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([legislationId, riskId])
  @@index([riskId])
  @@index([legislationId])
}

model SoAExport {
  id                String   @id
  generatedByUserId String
  generatedAt       DateTime @default(now())
  exportFormat      String
  filePath          String?
  User              User     @relation(fields: [generatedByUserId], references: [id])

  @@index([generatedAt])
  @@index([generatedByUserId])
}

model User {
  id             String           @id
  displayName    String
  email          String           @unique
  entraObjectId  String           @unique
  role           String           @default("STAFF")
  department     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Acknowledgment Acknowledgment[]
  Document       Document[]       @relation("DocumentOwner")
  ReviewTask     ReviewTask[]
  ownedRisks     Risk[]           @relation("RiskOwner")
  SoAExport      SoAExport[]
  supplierRelationshipOwner Supplier[] @relation("SupplierRelationshipOwner")
  supplierCreatedBy         Supplier[] @relation("SupplierCreatedBy")
  supplierUpdatedBy         Supplier[] @relation("SupplierUpdatedBy")
  riskAssessmentsAssessedBy    SupplierRiskAssessment[] @relation("RiskAssessmentAssessedBy")
  riskAssessmentsApprovedBy    SupplierRiskAssessment[] @relation("RiskAssessmentApprovedBy")
  criticalityAssessmentsAssessedBy SupplierCriticalityAssessment[] @relation("CriticalityAssessmentAssessedBy")
  criticalityAssessmentsApprovedBy SupplierCriticalityAssessment[] @relation("CriticalityAssessmentApprovedBy")
  supplierComplianceReviewsReviewedBy SupplierComplianceReview[] @relation("SupplierComplianceReviewReviewedBy")

  @@index([entraObjectId])
  @@index([email])
  @@index([department])
}

model ExternalUser {
  id                   String          @id @default(uuid())
  email                String          @unique
  passwordHash         String
  companyName          String
  isApproved           Boolean         @default(false)
  passwordResetToken   String?
  passwordResetExpires DateTime?
  tokenVersion         Int             @default(0)
  termsAcceptedAt      DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  TrustDownload        TrustDownload[]
  TrustAuditLog        TrustAuditLog[] @relation("PerformedByExternalUser")

  @@index([email])
  @@index([isApproved])
}

model TrustDocSetting {
  id                String          @id @default(uuid())
  documentId        String          @unique
  visibilityLevel   String
  category          String
  sharePointUrl     String?
  sharePointSiteId  String?
  sharePointDriveId String?
  sharePointItemId  String?
  publicDescription String?
  displayOrder      Int?
  requiresNda       Boolean         @default(false)
  maxFileSizeMB     Int?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  Document          Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  TrustDownload     TrustDownload[] @relation
  TrustAuditLog     TrustAuditLog[] @relation

  @@index([visibilityLevel])
  @@index([category])
  @@index([displayOrder])
}

model TrustDownload {
  id              String           @id @default(uuid())
  externalUserId  String?
  docId           String
  downloadToken   String?
  termsAccepted   Boolean          @default(false)
  timestamp       DateTime         @default(now())
  ExternalUser    ExternalUser?    @relation(fields: [externalUserId], references: [id], onDelete: Cascade)
  TrustDocSetting TrustDocSetting? @relation(fields: [docId], references: [documentId], onDelete: Cascade)

  @@index([externalUserId])
  @@index([docId])
  @@index([timestamp])
}

model TrustAuditLog {
  id                        String           @id @default(uuid())
  action                    String
  performedByUserId         String?
  performedByExternalUserId String?
  targetUserId              String?
  targetDocumentId          String?
  details                   String?
  ipAddress                 String?
  timestamp                 DateTime         @default(now())
  PerformedByExternalUser   ExternalUser?    @relation("PerformedByExternalUser", fields: [performedByExternalUserId], references: [id])
  TrustDocSetting           TrustDocSetting? @relation(fields: [targetDocumentId], references: [documentId], onDelete: Cascade)

  @@index([action])
  @@index([timestamp])
  @@index([performedByUserId])
  @@index([targetDocumentId])
}

model TrustCenterSettings {
  id              String   @id @default(uuid())
  key             String   @unique
  watermarkPrefix String   @default("Paythru Confidential")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([key])
}

model SupplierRiskAssessment {
  id                String   @id @default(uuid())
  supplierId        String
  ciaImpact         String
  supplierType      String
  riskRating        String
  rationale         String?
  assessedByUserId  String
  assessedAt        DateTime @default(now())
  approvedByUserId   String?
  approvedAt         DateTime?
  status             String   @default("DRAFT")
  rejectionReason    String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  supplier           Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  assessedBy         User     @relation("RiskAssessmentAssessedBy", fields: [assessedByUserId], references: [id])
  approvedBy         User?    @relation("RiskAssessmentApprovedBy", fields: [approvedByUserId], references: [id])
  currentSupplier    Supplier? @relation("CurrentRiskAssessment")

  @@index([supplierId])
  @@index([status])
  @@index([assessedByUserId])
  @@index([approvedByUserId])
}

model SupplierCriticalityAssessment {
  id                   String   @id @default(uuid())
  supplierId           String
  criticality          String
  rationale            String?
  supportingEvidenceLinks Json?
  assessedByUserId     String
  assessedAt           DateTime @default(now())
  approvedByUserId      String?
  approvedAt           DateTime?
  status               String   @default("DRAFT")
  rejectionReason      String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  supplier             Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  assessedBy           User     @relation("CriticalityAssessmentAssessedBy", fields: [assessedByUserId], references: [id])
  approvedBy           User?    @relation("CriticalityAssessmentApprovedBy", fields: [approvedByUserId], references: [id])
  currentSupplier      Supplier? @relation("CurrentCriticalityAssessment")

  @@index([supplierId])
  @@index([status])
  @@index([assessedByUserId])
  @@index([approvedByUserId])
}

model SupplierRiskLink {
  supplierId String
  riskId     String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  risk       Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@id([supplierId, riskId])
  @@index([riskId])
  @@index([supplierId])
}

model SupplierControlLink {
  supplierId String
  controlId  String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  control    Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([supplierId, controlId])
  @@index([controlId])
  @@index([supplierId])
}

model SupplierComplianceReview {
  id                    String   @id @default(uuid())
  supplierId            String
  reviewType            String
  plannedAt             DateTime
  completedAt           DateTime?
  reviewedByUserId      String?
  checksPerformed        String?
  outcome                String?
  updatedPerformanceRating String?
  notes                 String?
  evidenceLinks         Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  supplier              Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  reviewedBy            User?     @relation("SupplierComplianceReviewReviewedBy", fields: [reviewedByUserId], references: [id])

  @@index([supplierId])
  @@index([reviewType])
  @@index([plannedAt])
  @@index([completedAt])
  @@index([outcome])
}

model SupplierCertificate {
  id                String   @id @default(uuid())
  supplierId        String
  certificateType   String
  certificateNumber String?
  issuer            String?
  issueDate         DateTime?
  expiryDate        DateTime
  evidenceLink      String?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  supplier          Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([certificateType])
  @@index([expiryDate])
}

model SupplierExitPlan {
  id                        String   @id @default(uuid())
  supplierId                String   @unique
  reason                    String?
  startDate                 DateTime?
  targetEndDate             DateTime?
  completedAt               DateTime?
  status                    String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  impactAssessment          Json?    // { notes: string, scopeOfServices: string, dependencies: string[], stakeholders: string[], completed: boolean }
  dataAndIpr                Json?    // { notes: string, dataInventory: string, exportDetails: string, integrityValidation: string, iprTransfer: string, deletionConfirmation: string, completed: boolean }
  replacementServiceAnalysis Json?   // { notes: string, alternativeProviders: string[], securityComplianceChecks: string, pocNotes: string, tcoAnalysis: string, completed: boolean }
  contractClosure            Json?    // { notes: string, obligationsMet: string[], handoverDocs: string[], ticketClosure: string[], serviceCessationEvidence: string[], completed: boolean }
  lessonsLearned            Json?    // { notes: string, findings: string[], completed: boolean }
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  supplier                  Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([status])
  @@index([startDate])
  @@index([targetEndDate])
  @@index([completedAt])
}

model Supplier {
  id                        String   @id @default(uuid())
  name                      String
  tradingName               String?
  status                    String   @default("ACTIVE")
  supplierType              String
  serviceSubType            String?
  serviceDescription        String?
  processesCardholderData   Boolean  @default(false)
  processesPersonalData     Boolean  @default(false)
  hostingRegions            Json?
  customerFacingImpact      Boolean  @default(false)
  ciaImpact                 String?
  overallRiskRating         String?
  criticality               String?
  riskRationale             String?
  criticalityRationale      String?
  lastRiskAssessmentAt      DateTime?
  lastCriticalityAssessmentAt DateTime?
  pciStatus                 String?
  iso27001Status            String?
  iso22301Status            String?
  iso9001Status             String?
  gdprStatus                String?
  lastComplianceReviewAt    DateTime?
  complianceEvidenceLinks   Json?
  relationshipOwnerUserId   String?
  primaryContacts           Json?
  contractReferences        Json?
  dataProcessingAgreementRef String?
  contractStartDate         DateTime?
  contractEndDate           DateTime?
  autoRenewal               Boolean  @default(false)
  performanceRating          String?
  performanceNotes           String?
  createdAt                 DateTime  @default(now())
  createdByUserId           String?
  updatedAt                 DateTime  @updatedAt
  updatedByUserId           String?
  relationshipOwner         User?    @relation("SupplierRelationshipOwner", fields: [relationshipOwnerUserId], references: [id])
  createdBy                 User?    @relation("SupplierCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy                 User?    @relation("SupplierUpdatedBy", fields: [updatedByUserId], references: [id])
  lifecycleState            String   @default("DRAFT")
  cisoExemptionGranted      Boolean  @default(false)
  currentRiskAssessmentId    String? @unique
  currentCriticalityAssessmentId String? @unique
  riskAssessments            SupplierRiskAssessment[]
  criticalityAssessments     SupplierCriticalityAssessment[]
  currentRiskAssessment      SupplierRiskAssessment? @relation("CurrentRiskAssessment", fields: [currentRiskAssessmentId], references: [id])
  currentCriticalityAssessment SupplierCriticalityAssessment? @relation("CurrentCriticalityAssessment", fields: [currentCriticalityAssessmentId], references: [id])
  nextReviewAt               DateTime?
  lastReviewAt               DateTime?
  supplierRisks               SupplierRiskLink[]
  supplierControls            SupplierControlLink[]
  complianceReviews           SupplierComplianceReview[]
  certificates                SupplierCertificate[]
  reviewTasks                 ReviewTask[]
  exitPlan                    SupplierExitPlan?
  showInTrustCenter           Boolean  @default(false)
  trustCenterDisplayName      String?
  trustCenterDescription      String?
  trustCenterCategory         String?
  trustCenterComplianceSummary String?

  @@index([status])
  @@index([nextReviewAt])
  @@index([lastReviewAt])
  @@index([supplierType])
  @@index([criticality])
  @@index([pciStatus])
  @@index([iso27001Status])
  @@index([performanceRating])
  @@index([relationshipOwnerUserId])
  @@index([name])
  @@index([lifecycleState])
  @@index([currentRiskAssessmentId])
  @@index([currentCriticalityAssessmentId])
  @@index([showInTrustCenter])
  @@index([trustCenterCategory])
}
