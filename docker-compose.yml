services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: isms_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      # Use ollama CLI to check if service is running and responding
      test: ["CMD-SHELL", "ollama list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  document-service:
    build:
      context: ./services/document-service
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=development
      - PORT=4001
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN:-dev-token-change-me}
      - CACHE_DIR=/cache
    volumes:
      - document_cache:/cache
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4001/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      default:
        aliases:
          - document-service.local

  ai-service:
    build:
      context: ./services/ai-service
      dockerfile: Dockerfile
    ports:
      - "4002:4002"
    environment:
      - NODE_ENV=development
      - PORT=4002
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN:-dev-token-change-me}
      - OLLAMA_ENDPOINT=http://ollama:11434
      - OLLAMA_MODEL=nomic-embed-text
      - OLLAMA_EMBEDDING_MODEL=nomic-embed-text
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4002/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      default:
        aliases:
          - ai-service.local

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    env_file:
      - .env
      - ./backend/.env
    environment:
      - NODE_ENV=development
      - PORT=4000
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/isms_db?schema=public
      - SEED_SCOPE=full
      - DOCUMENT_SERVICE_URL=http://document-service.local:4001
      - AI_SERVICE_URL=http://ai-service.local:4002
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN:-dev-token-change-me}
      - DOCUMENT_SERVICE_TIMEOUT=30000
      - AI_SERVICE_TIMEOUT=10000
      # Legacy LLM config (for backward compatibility, but backend should use AI service)
      - LLM_BASE_URL=http://ollama:11434
      - LLM_EMBEDDING_MODEL=nomic-embed-text
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      document-service:
        condition: service_healthy
      ai-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:4000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => {process.exit(1)})\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:4000}
        VITE_AUTH_TENANT_ID: ${VITE_AUTH_TENANT_ID:-your-tenant-id}
        VITE_AUTH_CLIENT_ID: ${VITE_AUTH_CLIENT_ID:-your-client-id}
        VITE_AUTH_REDIRECT_URI: ${VITE_AUTH_REDIRECT_URI:-http://localhost:3000}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-dev}
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  postgres_data:
  ollama_data:
  document_cache:

networks:
  default:
    name: isms-documentation_default
